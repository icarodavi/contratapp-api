---
description: 
globs: 
alwaysApply: true
---
# üéØ Disputa Eletr√¥nica - Regras e Diretrizes

## Vis√£o Geral
O m√≥dulo de disputa √© o n√∫cleo do sistema de licita√ß√µes, gerenciando todo o processo de disputa eletr√¥nica conforme a Lei 14.133/21.

## Estrutura do M√≥dulo

### Modelo de Dados (Prisma)
```prisma
model Disputa {
  id              String          @id @default(uuid())
  editalId        String
  status          StatusDisputa
  dataInicio      DateTime?
  dataFim         DateTime?
  dataPausa       DateTime?
  motivoPausa     String?
  valorReferencia Int            // em centavos
  lances          Lance[]
  propostas       Proposta[]
  documentos      DocumentoLicitante[]
  mensagens       MensagemChat[]
  licitantes      LicitanteDisputa[]
  logs            LogAtividade[]
  edital          Edital          @relation(fields: [editalId], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

enum StatusDisputa {
  AGUARDANDO_INICIO
  EM_ANDAMENTO
  PAUSADA
  SUSPENSA
  ENCERRADA
  FRACASSADA
  DESERTA
  REVOGADA
  ANULADA
}
```

## Estados e Transi√ß√µes

### Diagrama de Estados
```
AGUARDANDO_INICIO -> EM_ANDAMENTO -> ENCERRADA
                  -> DESERTA
EM_ANDAMENTO -> PAUSADA -> EM_ANDAMENTO
             -> SUSPENSA -> EM_ANDAMENTO
             -> FRACASSADA
             -> REVOGADA
             -> ANULADA
```

### Regras de Transi√ß√£o
1. Somente PREGOEIRO pode alterar estados
2. Cada transi√ß√£o deve ser registrada em `LogAtividade`
3. Transi√ß√µes inv√°lidas devem ser bloqueadas
4. Notificar todos os participantes via WebSocket

## Regras de Neg√≥cio

### In√≠cio da Disputa
1. Verificar documenta√ß√£o obrigat√≥ria dos licitantes
2. Confirmar presen√ßa m√≠nima de participantes
3. Validar propostas iniciais
4. Iniciar cron√¥metro oficial

### Durante a Disputa
1. Controle de tempo pelo servidor
2. Valida√ß√£o de lances:
   - Valor menor que lance anterior
   - Dentro do tempo permitido
   - Licitante habilitado
3. Empate ficto (ME/EPP):
   - Diferen√ßa at√© 5% do menor lance
   - Prioridade para ME/EPP
4. Chat em tempo real moderado

### Encerramento
1. Verificar condi√ß√µes de encerramento
2. Gerar ata da sess√£o
3. Exportar hist√≥rico de lances
4. Notificar vencedor e demais participantes

## Implementa√ß√£o

### Controller
```typescript
@Controller('disputas')
@ApiTags('Disputas')
export class DisputaController {
  @Post()
  @Roles(PerfilUsuario.PREGOEIRO)
  async create(@Body() createDisputaDto: CreateDisputaDto) {
    // Criar nova disputa
  }

  @Patch(':id/status')
  @Roles(PerfilUsuario.PREGOEIRO)
  async updateStatus(
    @Param('id') id: string,
    @Body() updateStatusDto: UpdateStatusDisputaDto
  ) {
    // Atualizar status
  }

  @Get(':id/lances')
  async getLances(@Param('id') id: string) {
    // Listar lances
  }
}
```

### Service
```typescript
@Injectable()
export class DisputaService {
  async iniciarDisputa(id: string) {
    // Valida√ß√µes
    // Atualizar status
    // Notificar participantes
    // Iniciar cron√¥metro
  }

  async validarLance(lance: CreateLanceDto) {
    // Validar valor
    // Verificar tempo
    // Checar habilita√ß√£o
  }

  async verificarEmpateFicto(disputaId: string) {
    // Calcular diferen√ßa
    // Identificar ME/EPP
    // Notificar direito de prefer√™ncia
  }
}
```

### Gateway
```typescript
@WebSocketGateway({
  namespace: 'disputa'
})
export class DisputaGateway {
  @SubscribeMessage('lance')
  async handleLance(
    @MessageBody() data: CreateLanceDto,
    @ConnectedSocket() client: Socket
  ) {
    // Processar lance
    // Broadcast atualiza√ß√£o
  }
}
```

## Valida√ß√µes e Seguran√ßa

### Valida√ß√µes
1. Valores monet√°rios sempre em centavos
2. Datas UTC para evitar problemas de timezone
3. Validar documentos obrigat√≥rios
4. Verificar integridade dos lances
5. Controlar tempo de forma precisa

### Seguran√ßa
1. Autentica√ß√£o via JWT
2. Autoriza√ß√£o por perfil
3. Rate limiting em lances
4. Logs de auditoria
5. Backup em tempo real

## Monitoramento

### M√©tricas Principais
1. N√∫mero de disputas ativas
2. Tempo m√©dio de disputa
3. Volume de lances
4. Taxa de sucesso
5. Lat√™ncia de opera√ß√µes

### Alertas
1. Falhas em transi√ß√µes
2. Erros em lances
3. Problemas de conex√£o
4. Sobrecarga do sistema
5. Tentativas de viola√ß√£o

## Integra√ß√µes
1. Sistema de documentos
2. M√≥dulo de chat
3. Gera√ß√£o de atas
4. Notifica√ß√µes por email
5. Exporta√ß√£o de dados

## Conformidade Legal
1. Lei 14.133/21
2. LC 123/2006 (ME/EPP)
3. LGPD
4. Normas de seguran√ßa digital
5. Requisitos de transpar√™ncia

