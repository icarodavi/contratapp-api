---
description: 
globs: 
alwaysApply: true
---
# SEMPRE UTILIZAR O CLEAN CODE E UTILIZAR S.O.L.I.D.
# üìò Regras e Diretrizes do Sistema de Licita√ß√£o P√∫blica ‚Äî Fase de Disputa;

Este documento define as regras obrigat√≥rias para o desenvolvimento do sistema de **licita√ß√µes p√∫blicas**, com foco na **fase de disputa eletr√¥nica**, conforme os princ√≠pios da **Lei n¬∫ 14.133/21** (Nova Lei de Licita√ß√µes).

---

## ‚öñÔ∏è Princ√≠pios Legais Fundamentais

- **Transpar√™ncia**
- **Isonomia**
- **Rastreabilidade**
- **Seguran√ßa jur√≠dica**
- **Publicidade**
- **Competitividade**

---

## üß± Estrutura Geral do Sistema

- Backend: **NestJS + Prisma ORM**
- Banco de dados: **PostgreSQL**
- Frontend: **React ou Next.js**
- Comunica√ß√£o em tempo real: **WebSocket (socket.io)**
- Uploads: **Multer** (armazenamento local ou S3)
- Autentica√ß√£o: **JWT**
- √â obrigat√≥rio sempre seguir as diretrizes de Clean Code
- √â obrigat√≥rio sempre seguir o S.O.L.I.D.
- Todos os arquivos e coment√°rios devem sempre seguir Portugu√™s do Brasil.
- Sempre que for utilizar o PrismaORM sempre se atentar a utilizar a pasta /generated/prisma

---

## üìÇ Estrutura do Banco de Dados

### Armazenamento de valores monet√°rios
- Todos os valores financeiros devem ser armazenados como **inteiros (`Int`) em centavos**.
- Convers√£o para reais deve ser feita apenas no frontend com `valor / 100`.

### Estrutura documental
- Licitantes devem enviar documentos vinculados √† disputa:
  - **Propostas**
  - **Documentos de habilita√ß√£o**
  - **Outros documentos t√©cnicos**
- Documentos devem ter:
  - Vers√£o
  - Indica√ß√£o de validade
  - Nome original
  - Descri√ß√£o opcional
  - Assinatura (manual ou digital, se aplic√°vel)
  - Hash do arquivo para verifica√ß√£o de integridade

### Documentos obrigat√≥rios
- Cada edital pode configurar os **tipos de documentos exigidos** para protocola√ß√£o por parte dos licitantes.

---

## üí¨ Comunica√ß√£o (Chat P√∫blico)

- A fase de disputa deve conter um **chat p√∫blico** em tempo real.
- Participantes autorizados:
  - **Pregoeiro** (ou comiss√£o)
  - **Licitantes autenticados**
- Todas as mensagens devem:
  - Ser armazenadas no banco
  - Exibir tipo de autor (`PREGOEIRO` ou `LICITANTE`)
  - Ser vis√≠veis para todos os participantes da disputa
  - Registrar hor√°rio de envio

---

## ‚è≥ Controle de Tempo da Disputa

- O **tempo oficial da disputa √© controlado exclusivamente pelo servidor**.
- O cliente nunca √© fonte de verdade sobre tempo.
- Eventos de controle:
  - `INICIAR`, `PAUSAR`, `RETOMAR`, `ENCERRAR`
- Sincroniza√ß√£o por WebSocket:
  - Enviar `tempoRestante` e `timestampServidor`
  - Os clientes ajustam o rel√≥gio com base nisso
- Os participantes devem visualizar o mesmo cron√¥metro, com varia√ß√£o m√°xima de 1 segundo.

---

## üîê Autentica√ß√£o e Perfis

- O sistema deve prever os seguintes perfis:
  - `ADMIN`: acesso total ao sistema
  - `PREGOEIRO`: controle da disputa
  - `LICITANTE`: envio de documentos, participa√ß√£o em lances e chat
  - `VISUALIZADOR`: acesso apenas para acompanhamento
- Toda a√ß√£o sens√≠vel deve ser rastreada com `usuarioId`, IP, timestamp e hash de sess√£o.

---

## üìú Logs e Rastreabilidade

- Deve existir a tabela `LogAtividade` para registrar eventos cr√≠ticos:
  - Abertura e encerramento de disputa
  - Envio de proposta ou documentos
  - Controle de tempo
  - Entradas e sa√≠das de usu√°rios no sistema

---

## üîç Valida√ß√£o de Documentos e QR Code

- Todo documento relevante (proposta, ata, contrato) deve ter op√ß√£o de:
  - **Valida√ß√£o p√∫blica** via rota `/validar/:id`
  - Inclus√£o de **QR Code** no PDF gerado, apontando para a valida√ß√£o p√∫blica

---

## üìà Regras de Lances

- Lances devem ser:
  - V√°lidos somente durante o tempo da disputa
  - **Decrescentes**
  - De valor inferior ao lance anterior
- Todos os lances devem registrar:
  - IP, user-agent, hor√°rio
  - `sessaoId` para rastreabilidade
- A l√≥gica de empate ficto deve considerar ME/EPP com diferen√ßa de at√© 5%

---


## üìå Regras T√©cnicas de Upload

- Os documentos enviados devem ser organizados em: /uploads/{disputaId}/{licitanteId}/{tipoDocumento}/{versao}.pdf

- Os uploads devem ser protegidos por autentica√ß√£o e autorizados conforme o papel do usu√°rio.

---

## üöß Considera√ß√µes Finais

- O sistema deve estar preparado para m√∫ltiplas prefeituras ou √≥rg√£os licitantes.
- Cada disputa deve ser independente e isolada em termos de:
- Documentos
- Participantes
- Chat
- Tempo
- O c√≥digo deve ser limpo, versionado em Git, com testes automatizados para os servi√ßos cr√≠ticos.
